<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>framespace - WebGPU</title>
    <style>
      html, body {
        margin: 0;
        width: 100%;
        height: 100%;
        background: #0b0f17;
        color: #dce3f1;
        font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      }

      body {
        display: grid;
        grid-template-rows: auto 1fr;
      }

      .topbar {
        padding: 10px 14px;
        border-bottom: 1px solid #1f2a3f;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .tool-btn {
        border: 1px solid #2f4a78;
        background: #132440;
        color: #dbe6fa;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        cursor: pointer;
      }

      .tool-btn.warn {
        border-color: #6c3652;
        background: #2a1624;
      }

      .app {
        display: grid;
        grid-template-columns: 1fr 280px;
        min-height: 0;
        min-width: 0;
        height: 100%;
      }

      .viewport {
        position: relative;
        min-width: 0;
        min-height: 0;
        background: radial-gradient(circle at 30% 20%, #19263f, #0b0f17 60%);
      }

      #canvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      .sidebar {
        border-left: 1px solid #1f2a3f;
        background: linear-gradient(180deg, #0f1829, #0b111c 45%, #0a1018);
        padding: 12px;
        display: grid;
        grid-template-rows: auto auto 1fr auto;
        gap: 10px;
      }

      .sidebar h3 {
        margin: 0;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #9cb3d6;
      }

      .hint {
        margin: 0;
        font-size: 12px;
        color: #b8c6df;
        line-height: 1.5;
      }

      .status {
        margin: 0;
        font-size: 11px;
        color: #9cb3d6;
      }

      #snapshot-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        overflow: auto;
        min-height: 0;
      }

      .snapshot-item {
        border: 1px solid #2a3a59;
        background: #111d33;
        border-radius: 8px;
        padding: 6px;
        text-align: left;
        color: #dbe6fa;
        cursor: pointer;
      }

      .snapshot-item.selected {
        border-color: #79b2ff;
        box-shadow: 0 0 0 1px rgba(121, 178, 255, 0.35) inset;
        background: #162744;
      }

      .snapshot-item img {
        width: 100%;
        border-radius: 4px;
        display: block;
        margin-bottom: 6px;
      }

      .snapshot-item .meta {
        font-size: 11px;
        color: #9fb4d8;
      }

      @media (max-width: 960px) {
        .app {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr 220px;
        }

        .sidebar {
          border-left: none;
          border-top: 1px solid #1f2a3f;
        }

        #snapshot-list {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div>framespace | Capture with <b>P</b>, place selected shot with <b>E</b></div>
      <div class="toolbar">
        <button id="btn-capture" class="tool-btn" type="button">Capture</button>
        <button id="btn-place" class="tool-btn" type="button">Place</button>
        <button id="btn-remove" class="tool-btn" type="button">Remove Selected</button>
        <button id="btn-clear" class="tool-btn warn" type="button">Clear All</button>
      </div>
    </div>
    <div class="app">
      <div class="viewport"><canvas id="canvas"></canvas></div>
      <aside class="sidebar">
        <h3>Snapshot Inventory</h3>
        <p class="hint">캔버스를 클릭한 뒤 <b>P</b>로 사진을 찍고, 우측 썸네일을 선택한 다음 <b>E</b>로 월드에 배치하세요.</p>
        <p id="snapshot-status" class="status">shots: 0 / 48</p>
        <div id="snapshot-list"></div>
        <p class="hint">WASD 이동 / Shift 가속 / 마우스 시점</p>
      </aside>
    </div>

    <script>
      (() => {
        const MAX_SHOTS = 48;
        const shots = new Map();
        let selectedShotId = 0;
        const list = document.getElementById('snapshot-list');
        const statusEl = document.getElementById('snapshot-status');

        function updateStatus() {
          statusEl.textContent = `shots: ${shots.size} / ${MAX_SHOTS}`;
        }

        function invokeNative(fnName) {
          if (!window.Module || typeof window.Module.ccall !== 'function') {
            console.warn(`[UI] ${fnName} ignored: runtime not ready`);
            return;
          }
          window.Module.ccall(fnName, null, [], []);
        }

        function disposeShot(shot) {
          if (shot && shot.objectUrl) {
            URL.revokeObjectURL(shot.objectUrl);
          }
        }

        function removeShotById(id) {
          const shot = shots.get(id);
          if (!shot) return;
          disposeShot(shot);
          shots.delete(id);

          if (selectedShotId === id) {
            const remaining = [...shots.keys()].sort((a, b) => b - a);
            selectedShotId = remaining.length ? remaining[0] : 0;
          }
          renderInventory();
        }

        function clearAllShots() {
          for (const shot of shots.values()) {
            disposeShot(shot);
          }
          shots.clear();
          selectedShotId = 0;
          renderInventory();
        }

        function renderInventory() {
          list.innerHTML = '';
          const ids = [...shots.keys()].sort((a, b) => b - a);
          const frag = document.createDocumentFragment();

          for (const id of ids) {
            const shot = shots.get(id);
            const btn = document.createElement('button');
            btn.className = 'snapshot-item' + (id === selectedShotId ? ' selected' : '');
            btn.type = 'button';

            const img = document.createElement('img');
            img.src = shot.objectUrl;
            img.alt = `shot-${id}`;
            btn.appendChild(img);

            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = `shot #${id}`;
            btn.appendChild(meta);

            btn.addEventListener('click', () => {
              selectedShotId = id;
              renderInventory();
            });

            frag.appendChild(btn);
          }

          list.appendChild(frag);
          updateStatus();
        }

        window.__framespaceAddSnapshotFromCanvas = async (shotId) => {
          const canvas = document.querySelector('#canvas');
          if (!canvas) return;
          const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png'));
          if (!blob) return;

          const prev = shots.get(shotId);
          disposeShot(prev);
          shots.set(shotId, { objectUrl: URL.createObjectURL(blob) });
          selectedShotId = shotId;

          while (shots.size > MAX_SHOTS) {
            const oldestId = Math.min(...shots.keys());
            removeShotById(oldestId);
          }

          renderInventory();
        };

        window.__framespaceGetSelectedShotId = () => selectedShotId || 0;
        window.__framespaceHasShotId = (shotId) => shots.has(shotId);

        document.getElementById('btn-capture').addEventListener('click', () => {
          invokeNative('framespace_trigger_capture');
        });

        document.getElementById('btn-place').addEventListener('click', () => {
          invokeNative('framespace_trigger_place');
        });

        document.getElementById('btn-remove').addEventListener('click', () => {
          if (!selectedShotId) return;
          removeShotById(selectedShotId);
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
          clearAllShots();
        });

        updateStatus();
      })();
    </script>
    {{{ SCRIPT }}}
  </body>
</html>
